ARG RUST_VERSION=1.89.0
FROM rust:${RUST_VERSION}-bookworm AS agent-builder

WORKDIR /usr/src/

# Create a dummy project structure that matches the workspace
RUN USER=root cargo new --bin podpilot-agent
WORKDIR /usr/src/podpilot-agent

# Copy dependency files FROM THE WORKSPACE ROOT
COPY ./Cargo.toml ./Cargo.lock ./
COPY ./podpilot-agent/Cargo.toml ./podpilot-agent/
COPY ./podpilot-hub/Cargo.toml ./podpilot-hub/
COPY ./podpilot-common/Cargo.toml ./podpilot-common/

# Build dependencies. This layer is cached as long as Cargo files don't change.
# Create dummy files for all workspace members to allow dependency-only build
RUN mkdir -p ./podpilot-agent/src && echo "fn main() {}" > ./podpilot-agent/src/main.rs
RUN mkdir -p ./podpilot-hub/src && echo "fn main() {}" > ./podpilot-hub/src/main.rs
RUN mkdir -p ./podpilot-common/src && echo "pub fn hello() {}" > ./podpilot-common/src/lib.rs
# The --workspace flag is important here
RUN cargo build --workspace --release

# Copy the actual agent source code
RUN rm ./podpilot-agent/src/*.rs ./podpilot-common/src/*.rs
COPY ./podpilot-agent/src ./podpilot-agent/src/
COPY ./podpilot-common/src ./podpilot-common/src/

# Build agent binary
RUN rm ./target/release/deps/podpilot_agent*
# Specify the package to build
RUN cargo build --release --package podpilot-agent

# Strip the binary to reduce size
RUN strip ./target/release/podpilot-agent

# --- Final Runtime Image ---
FROM debian:12-slim as agent-runtime

# Install iptables using apt-get for the new base image. --no-install-recommends keeps the image small.
RUN apt-get update && apt-get install -y --no-install-recommends iptables libssl3 && rm -rf /var/lib/apt/lists/*

# Copy agent binary to production image.
COPY --from=agent-builder /usr/src/podpilot-agent/target/release/podpilot-agent /app/podpilot-agent

# Expose agent binary path to the runtime environment
ENV AGENT_BIN=/app/podpilot-agent

# Copy Tailscale binaries
COPY --from=docker.io/tailscale/tailscale:stable /usr/local/bin/tailscaled /usr/local/bin/tailscaled
COPY --from=docker.io/tailscale/tailscale:stable /usr/local/bin/tailscale /usr/local/bin/tailscale

# Copy a startup script into the container
COPY ./podpilot-agent/boot.sh /app/boot.sh
RUN chmod +x /app/boot.sh

# The entrypoint is now the startup script
CMD ["/app/boot.sh"]

