name: Build App Images

on:
  push:
    branches: [master]
    paths:
      - "crates/podpilot-agent/**"
      - "crates/podpilot-common/**"
      - "apps/**"
      - "docker-bake.hcl"
      - ".github/workflows/build-apps.yml"
  pull_request:
    paths:
      - "crates/podpilot-agent/**"
      - "crates/podpilot-common/**"
      - "apps/**"
      - "docker-bake.hcl"
      - ".github/workflows/build-apps.yml"
  workflow_dispatch:
    inputs:
      targets:
        description: "Comma-delimited groups (static,live) or specific targets (a1111-cu121,comfyui-cu128-live)"
        required: false
        default: "static,live"
  workflow_run:
    workflows: ["Build Base Images"]
    types: [completed]
    branches: [master]

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' && (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success')
    permissions:
      pull-requests: read
    outputs:
      changed_apps: ${{ steps.filter.outputs.changes }}
      build_all: ${{ steps.filter.outputs.common }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'crates/podpilot-agent/**'
              - 'crates/podpilot-common/**'
              - 'apps/Dockerfile.base'
              - 'apps/Dockerfile.compose'
              - 'docker-bake.hcl'
              - '.github/workflows/build-apps.yml'
            a1111:
              - 'apps/a1111/**'
            comfyui:
              - 'apps/comfyui/**'
            fooocus:
              - 'apps/fooocus/**'
            kohya:
              - 'apps/kohya/**'

  set-matrix:
    name: Set Build Matrix
    needs: detect-changes
    if: always() && (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate build matrix
        id: generate-matrix
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TARGETS: ${{ inputs.targets }}
          CHANGED_APPS: ${{ needs.detect-changes.outputs.changed_apps }}
          BUILD_ALL: ${{ needs.detect-changes.outputs.build_all }}
        run: |
          # Determine which targets/groups to build
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            # Parse comma-separated targets input, remove whitespace, deduplicate
            TARGETS=$(echo "$INPUT_TARGETS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sort -u | paste -sd ' ')
          else
            # Build both static and live groups for push/workflow_run
            TARGETS="static live"
          fi

          echo "Targets to build: $TARGETS"

          # Extract all composition targets from bake configuration
          # Include 'bases' group so Bake can resolve base image dependencies (will use cache)
          # shellcheck disable=SC2086
          ALL_TARGETS=$(docker buildx bake --print bases $TARGETS 2>/dev/null | \
            jq -r '.target | keys[] | select(contains("-app-") | not) | select(startswith("base-") | not) | select(startswith("agent-") | not)')

          # Filter targets based on changed apps (unless building all or manual dispatch)
          if [ "$EVENT_NAME" != "workflow_dispatch" ] && [ "$BUILD_ALL" != "true" ] && [ -n "$CHANGED_APPS" ] && [ "$CHANGED_APPS" != "[]" ]; then
            echo "Filtering targets by changed apps: $CHANGED_APPS"
            MATRIX=$(echo "$ALL_TARGETS" | jq -R -s -c --argjson apps "$CHANGED_APPS" \
              '[split("\n") | .[] | select(length > 0) | select(. as $target | $apps | map(. + "-") | any(. as $prefix | $target | startswith($prefix)))] | {include: map({target: .})}')
          else
            if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
              echo "Manual dispatch: building specified targets"
            elif [ "$BUILD_ALL" = "true" ]; then
              echo "Common files changed: building all targets"
            else
              echo "Building all targets (no app-specific changes detected)"
            fi
            MATRIX=$(echo "$ALL_TARGETS" | jq -R -s -c '[split("\n") | .[] | select(length > 0)] | {include: map({target: .})}')
          fi

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "Generated matrix:"
          echo "$MATRIX" | jq .

  build-agent:
    name: Build Agent Binary
    needs: set-matrix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_run'
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push agent
        uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          targets: agent-binary
          push: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_run' }}
          set: |
            agent-binary.attest=type=provenance,mode=max
            agent-binary.attest=type=sbom

  build-apps:
    name: Build ${{ matrix.target }}
    needs: [set-matrix, build-agent]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: sudo bash .github/scripts/space.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_run'
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build app image
        uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          targets: |
            bases
            agent-binary
            ${{ matrix.target }}
          push: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_run' }}
          set: |
            *.attest=type=provenance,mode=max
            *.attest=type=sbom

      - name: Summary
        env:
          TARGET: ${{ matrix.target }}
          EVENT_NAME: ${{ github.event_name }}
          REF: ${{ github.ref }}
          REGISTRY_USER: ${{ github.repository_owner }}
        run: |
          REGISTRY_USER_LOWER="${REGISTRY_USER,,}"

          # Extract app name from target (everything before -cu)
          APP=$(echo "$TARGET" | sed -E 's/-cu[0-9]+.*//')

          echo "### Built ${TARGET} :rocket:" >> "$GITHUB_STEP_SUMMARY"
          if [ "$EVENT_NAME" = "push" ] && [ "$REF" = "refs/heads/master" ]; then
            echo "Pushed to: \`ghcr.io/${REGISTRY_USER_LOWER}/podpilot/${APP}:*\`" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$EVENT_NAME" = "workflow_run" ]; then
            echo "Pushed to: \`ghcr.io/${REGISTRY_USER_LOWER}/podpilot/${APP}:*\`" >> "$GITHUB_STEP_SUMMARY"
            echo "Triggered by base image update" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Build only (not pushed)" >> "$GITHUB_STEP_SUMMARY"
          fi
