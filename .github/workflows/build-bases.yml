name: Build Base Images

on:
  workflow_dispatch:
    inputs:
      variant:
        description: "Which base images to build"
        required: true
        type: choice
        options:
          - all
          - cuda-12.1
          - cuda-12.4
          - cuda-12.8
        default: "all"
  schedule:
    # Weekly on Sunday at 2 AM UTC for security updates
    - cron: "0 2 * * 0"

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  set-matrix:
    name: Set Build Matrix
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.set-variants.outputs.variants }}
    steps:
      - name: Set variants to build
        id: set-variants
        env:
          VARIANT: ${{ inputs.variant }}
        run: |
          case "$VARIANT" in
            cuda-12.1)
              echo 'variants=["base-cu121"]' >> "$GITHUB_OUTPUT"
              ;;
            cuda-12.4)
              echo 'variants=["base-cu124"]' >> "$GITHUB_OUTPUT"
              ;;
            cuda-12.8)
              echo 'variants=["base-cu128"]' >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo 'variants=["base-cu121","base-cu124","base-cu128"]' >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Show build matrix
        env:
          VARIANTS: ${{ steps.set-variants.outputs.variants }}
        run: |
          echo "Building base variants: $VARIANTS"

  build-bases:
    name: Build ${{ matrix.variant }}
    needs: set-matrix
    runs-on: ubuntu-latest
    outputs:
      variant: ${{ steps.set-output.outputs.variant }}
    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.set-matrix.outputs.variants) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: sudo bash .github/scripts/space.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get tag
        id: get-tag
        env:
          VARIANT: ${{ matrix.variant }}
        run: |
          # Extract tag from variant name (base-cu121 -> cu12.1)
          case "$VARIANT" in
            base-cu121) TAG="cu12.1" ;;
            base-cu124) TAG="cu12.4" ;;
            base-cu128) TAG="cu12.8" ;;
          esac

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push base image
        uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          targets: ${{ matrix.variant }}
          push: true
          set: |
            *.attest=type=provenance,mode=max
            *.attest=type=sbom

      - name: Set output for workflow trigger
        id: set-output
        env:
          VARIANT: ${{ matrix.variant }}
        run: |
          echo "variant=${VARIANT}" >> "$GITHUB_OUTPUT"
