name: Build Base Images

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Which base images to build'
        required: true
        type: choice
        options:
          - all
          - cuda-12.1
          - cuda-12.4
          - cuda-12.8
        default: 'all'
  schedule:
    # Weekly on Sunday at 2 AM UTC for security updates
    - cron: '0 2 * * 0'

permissions:
  contents: read
  packages: write

jobs:
  set-matrix:
    name: Set Build Matrix
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.set-variants.outputs.variants }}
    steps:
      - name: Set variants to build
        id: set-variants
        env:
          VARIANT: ${{ inputs.variant }}
        run: |
          case "$VARIANT" in
            cuda-12.1)
              echo 'variants=["base-cu121"]' >> "$GITHUB_OUTPUT"
              ;;
            cuda-12.4)
              echo 'variants=["base-cu124"]' >> "$GITHUB_OUTPUT"
              ;;
            cuda-12.8)
              echo 'variants=["base-cu128"]' >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo 'variants=["base-cu121","base-cu124","base-cu128"]' >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Show build matrix
        env:
          VARIANTS: ${{ steps.set-variants.outputs.variants }}
        run: |
          echo "Building base variants: $VARIANTS"

  build-bases:
    name: Build ${{ matrix.variant }}
    needs: set-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.set-matrix.outputs.variants) }}

    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base image
        env:
          VARIANT: ${{ matrix.variant }}
        run: |
          docker buildx bake \
            --set "*.cache-from=type=gha,scope=${VARIANT}" \
            --set "*.cache-to=type=gha,mode=max,scope=${VARIANT}" \
            --push \
            "${VARIANT}"

      - name: Summary
        env:
          VARIANT: ${{ matrix.variant }}
          REGISTRY_USER: ${{ github.repository_owner }}
        run: |
          REGISTRY_USER_LOWER="${REGISTRY_USER,,}"
          echo "### Built ${VARIANT} :rocket:" >> "$GITHUB_STEP_SUMMARY"
          echo "Registry: \`ghcr.io/${REGISTRY_USER_LOWER}/podpilot-base:*\`" >> "$GITHUB_STEP_SUMMARY"
